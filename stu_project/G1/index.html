<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.52.0/dist/phaser.min.js"></script>

    <style type="text/css">
        body
        {
            margin:0;
            padding:0;
        }

    </style>
</head>
<body>
    <script>
        const config = 
        {
            type   : Phaser.AUTO,
            width  : 800,
            height : 600,
            
            

            physics: 
            {
                default: 'arcade',
                arcade : 
                {
                    gravity: {y: 500}
                }
            },

            scene  : 
            {
                preload: preload,
                create : create,
                update : update
            }
        };

        const game = new Phaser.Game(config);
        let platforms;
        let player;
        let cursors;
        let tempVX = 0;
        let easingVX;
        let doubleJump  = 1;
        let doubleJump2 = 0;
        let restartText;

        let check = 0;

        //星星與分數
        let stars;
        let pick = 0;
        let score = 0;
        let scoreText;

        //炸彈
        let bombs;
        let gameOver = false;

        //玩家腳底座標
        let playerF;
        let playerS;

        //玩家即時Y速度計算器
        let pY1;
        let pY2;
        let pYV;

        //玩家即時X速度計算器
        let pX1;
        let pX2;
        let pXV;

        //玩家周遭判定器
        let playerSuround;
        let san = 0;
        let Pl = 0;

        function preload()
        {
            

            this.load.image('sky','assets/sky2.png');
            this.load.image('ground','assets/platform_ice.png');
            this.load.image('wall','assets/platform_ice_2.png');
            this.load.image('star','assets/star.png');
            //this.load.image('bomb','/assets/Ame.png');
            this.load.image('step','assets/Fish.png');
            this.load.image('spear','assets/Gura_spear.png');

            this.load.audio("A",['assets/Gura_a.mp3']);
            this.load.audio("Music",['assets/Background_2.mp3']);
            this.load.audio("Shout",['assets/Gura_shout.mp3']);
            this.load.audio("Win",['assets/Ejected.mp3']);
            this.load.audio("Moving",['assets/FootStep.mp3']);
            this.load.audio("Jump",['assets/JumpSound.mp3']);
            this.load.audio("NewAme",['assets/AreYouWinning.mp3']);

            this.load.audio("Breath",['assets/SharkBreath.mp3']);

            this.load.spritesheet('dude','assets/Gura_add.png',
            {frameWidth: 32, frameHeight: 48});

            //Ame spriteSheet
            this.load.spritesheet('Ame','assets/Ame_add.png',
            {frameWidth: 28, frameHeight: 28});


            //玩家周遭範圍
            this.load.spritesheet('Suround','assets/Suround.png',
            {frameWidth:140,frameHeight:100});
        }
        
        
        

        function create()
        {
            Aa = this.sound.add("A",{loop: false}); 
            SharkShout = this.sound.add("Shout",{loop:false});
            SharkWin = this.sound.add("Win",{loop:false});
            
            Amespawn = this.sound.add("NewAme",{loop:false});
            
            SharkBreath = this.sound.add("Breath",
            {
                loop:true,
                volume:0.4
            });
            
            SharkJump = this.sound.add("Jump",
            {
                loop:false,
                rate:1.2,
                volume:0.4
            });


            SharkSteps = this.sound.add("Moving",
            {
                loop:true,
                rate:0.85,
                volume:0.15
            });

            
            BackgroundMusic = this.sound.add("Music",
            {
                loop:true,
                volume:0.8
            
            });
            
            BackgroundMusic.play();

            
            
            
            
            this.add.image(400,300,'sky');
            
            this.time.addEvent(
                {
                    delay:17,
                    callback:()=>
                    {
                        pY2 = pY1;
                        pX2 = pX1;

                    },   
                    loop:true
                });
            
            
            

            //建立場景    
            platforms = this.physics.add.staticGroup();

            platforms.create(800,20,'wall')

            platforms.create(180,588,'ground')
            platforms.create(560,588,'ground')
            platforms.create(800,588,'ground')
            platforms.create(600,400,'ground')
            platforms.create(20,250,'ground')
            platforms.create(750,220,'ground')
            
            
            platforms.create(350,200,'wall').setScale(0.5).refreshBody();

            scoreText = this.add.text(16,16,'Score:0',{font:'32px Arial Black',backgroundColor:'rgba(0,0,0,0.4)',color:'white',fixedWidth:config.width-600});

            restartText = this.add.text(config.width/2-100,config.height/2-40,'Restart',
            {
                font:'40px Arial Black',
                color:'white',
                stroke:'red',
                padding:10,
                backgroundColor:'rgba(0,0,0,0.4)'
            })
            
            restartText.visible = false;
                
            restartText.setInteractive().on('pointerdown',(pointer,localX,localY,event)=>
            {
                score = 0;
                gameOver = false;
                this.scene.restart();
            })
            
            //星星設定與碰撞物理
            stars = this.physics.add.group(
                {
                    key:'star',
                    repeat:11,
                    setXY:
                    {
                        x:22,
                        y:0,
                        stepX:70
                    }

                });
            stars.children.iterate(function(child)
            {
                child.setBounceY(Phaser.Math.FloatBetween(0.4,0.8));
            });

            //炸彈設定與碰撞物理
            bombs = this.physics.add.group(
                {
                    key:'Ame',
                    repeat:1,
                    setXY:
                    {
                        x:30,
                        y:0,
                        stepX:100
                    }
                })
            
            
            bombs.children.iterate(function(child)
            {
                child.setBounce(1);
                child.setVelocity(Phaser.Math.Between(-250,250),0);
                child.setCollideWorldBounds(true);
                child.allowGravity = false;
                
                //let distW = Phaser.Math.BetweenPoints(player.x-child.x,player.y-child.y);
            });

            //bombs.setBounce(1);
            //bombs.setCollideWorldBounds(true);
            //玩家周遭
            playerSuround = this.physics.add.sprite(100,450,'Suround');
            playerSuround.setBounce(false);
            playerSuround.setCollideWorldBounds(false);
            playerSuround.setGravity(false);
            playerSuround.setVisible(false);
            
            playerSuround.setImmovable();

            //玩家與地圖碰撞
            player = this.physics.add.sprite(100,450,'dude');
            player.setBounce(0.2);
            player.setCollideWorldBounds(true);

            //玩家腳底
            playerF = this.add.sprite(100,450,'dude');
            playerF.setVisible(false);

            playerS = this.add.sprite(100,450,'dude');
            playerS.setVisible(false);
            
            

           

            //Gura animation set
            this.anims.create(
                {
                    key: 'left',
                    frames: this.anims.generateFrameNumbers('dude',{start: 0,end: 3}),
                    frameRate: 12,
                    repeat: -1
                });

            this.anims.create(
            {
                key: 'turn',
                frames:[{key: 'dude',frame: 4}],
                frameRate: 20
            });

            this.anims.create(
                {
                    key: 'right',
                    frames: this.anims.generateFrameNumbers('dude',{start: 5,end: 8}),
                    frameRate:12,
                    repeat:-1
                });
            
            this.anims.create(
                {
                    key:'down',
                    frames:[{key:'dude',frame:9}],
                    frameRate:1
                })

            this.anims.create(
                {
                    key:'JumpLeft',
                    frames:[{key:'dude',frame:2}],
                    frameRate:12,
                    repeat:-1
                })
            
            this.anims.create(
                {
                    key:'JumpRight',
                    frames:[{key:'dude',frame:5}],
                    frameRate:12,
                    repeat:-1
                })

            //Ame animation set
            this.anims.create(
                {
                    key: 'AmeLeft',
                    frames:[{key:'Ame',frame:4}],
                    frameRate:20

                })
            
            this.anims.create(
                {
                    key: 'AmeRight',
                    frames:[{key:'Ame',frame:5}],
                    frameRate:20
                })
            
            this.anims.create(
                {
                    key: 'AmeLeftRotate',
                    frames: this.anims.generateFrameNumbers('Ame',{start: 3,end: 0}),
                    frameRate:8,
                    repeat:-1
                })

            this.anims.create(
                {
                    key: 'AmeRightRotate',
                    frames: this.anims.generateFrameNumbers('Ame',{start: 6,end: 9}),
                    frameRate:8,
                    repeat:-1
                })

            cursors = this.input.keyboard.createCursorKeys();
            this.physics.add.collider(player,platforms);
            this.physics.add.collider(stars,platforms);
            

            //撿星星
            this.physics.add.overlap(player,stars,collectStar,null,this);
            
            // //Ame靠近玩家
            this.physics.add.overlap(playerSuround,bombs,GuraBreath,null,this);
           
            
            //炸彈碰撞
            this.physics.add.collider(bombs,platforms);
            
            this.physics.add.collider(player,bombs,hitBomb,null,this);
            
            //Ame碰撞轉向
            this.physics.add.collider(bombs,platforms,AmeAnimation,null,this);


            //腳步特效
            let particles = this.add.particles('step');
            let emitter = particles.createEmitter(
                {
                    speed    : 30,
                    scale    : {start: 1.1,end: 0},
                    alpha    : {start: 1,end: 0.4},

                    accelerationX:-200,
                   
                    
                    blendMode: 'SCREEN'
                });
            
            emitter.startFollow(playerF);

            //三叉戟特效
            let particles2 = this.add.particles('spear');
            let emitter2 = particles2.createEmitter(
                {
                    speed    : 200,
                    scale    : {start: 0.6,end: 0},
                    alpha    : {start: 1,end: 0.4},

                    accelerationX:-400,
                    accelerationY:300,

                    blendMode: 'SCREEN'
                })
            emitter2.startFollow(playerS);

            //下雪特效
            let particles3 = this.add.particles('step');
            let emitter3 = particles3.createEmitter(
                {
                    x        : 100,
                    y        : -50,
                    
                    speed    : 400,
                    scale    : {start: 1,end: 0.3},
                    alpha    : {start: 0.4,end: 0},

                    rotate: Phaser.Math.Between(0,360),

                    accelerationX:-400,
                    accelerationY:-40,
                    


                    blendMode: 'SCREEN'
                })

            let particles4 = this.add.particles('step');
            let emitter4 = particles4.createEmitter(
                {
                    x        : 250,
                    y        : -50,
                    
                    speed    : 400,
                    scale    : {start: 1,end: 0},
                    alpha    : {start: 0.4,end: 0},

                    rotate: Phaser.Math.Between(0,360),

                    accelerationX:-400,
                    accelerationY:-40,
                    


                    blendMode: 'SCREEN'
                })

                let particles5 = this.add.particles('step');
            let emitter5 = particles5.createEmitter(
                {
                    x        : 400,
                    y        : -50,
                    
                    speed    : 400,
                    scale    : {start: 1,end: 0},
                    alpha    : {start: 0.4,end: 0},

                    rotate: Phaser.Math.Between(0,360),

                    accelerationX:-400,
                    accelerationY:-40,
                    


                    blendMode: 'SCREEN'
                })

                let particles6 = this.add.particles('step');
            let emitter6 = particles6.createEmitter(
                {
                    x        : 550,
                    y        : -50,
                    
                    speed    : 400,
                    scale    : {start: 1,end: 0},
                    alpha    : {start: 0.4,end: 0},

                    rotate: Phaser.Math.Between(0,360),

                    accelerationX:-400,
                    accelerationY:-40,
                    


                    blendMode: 'SCREEN'
                })

                let particles7 = this.add.particles('step');
            let emitter7 = particles7.createEmitter(
                {
                    x        : 700,
                    y        : -50,
                    
                    speed    : 400,
                    scale    : {start: 1,end: 0},
                    alpha    : {start: 0.4,end: 0},

                    rotate: Phaser.Math.Between(0,360),

                    accelerationX:-400,
                    accelerationY:-40,
                    


                    blendMode: 'SCREEN'
                })
            

        }

        
        
        function GuraBreath(playerSuround,bombs)
        {
            san = 1200;
            
            
            if(san>0 & Pl==0)
            {
                SharkBreath.play();
                Pl=1;
            } 
        
              
        }
        
        
        
            function collectStar(player,star)
        {
            pick = 1;
            star.disableBody(true,true);
            score +=10;
            scoreText.setText('Score:'+score);

            if(stars.countActive(true) === 0)
            {
                stars.children.iterate(function(child)
                {
                    child.enableBody(true,child.x,0,true,true);
                });
                let x = (player.x < 400) ? Phaser.Math.Between(400,800) : Phaser.Math.Between(0,400);
                let bomb = bombs.create(x,16,'Ame');
                bomb.setBounce(1);
                bomb.setCollideWorldBounds(true);
                bomb.setVelocity(Phaser.Math.Between(-200,200),20);
                bomb.allowGravity = false;

                Amespawn.play();


                        
            }


            
                
        }

        function AmeAnimation()
        {
           
        }

        function hitBomb(player,bomb)
        {
            if(pYV<700)
            {
                this.physics.pause();
                player.setTint(0xff0000);
                player.anims.play('turn');
                gameOver = true;
                SharkShout.play();  
            }

            if(pYV>=700)
            {
                bomb.disableBody(true,true);
                SharkWin.play();
                SharkBreath.pause();
            }
            
        }

        function update()
        {
            //console.log(player.body.velocity.x);
            
            //playerF.x = player.x;
            //playerF.y = player.y+30;
            
            //console.log(san);
            //console.log(pXV);
            //console.log(playerSuround.x,playerSuround.y);
            //console.log(player.y);
            
            //更新玩家XY值(在60幀下)
           
            pY1 = player.y;
            pX1 = player.x;
            pYV = (pY1-pY2)/0.017;
            pXV = (pX1-pX2)/0.017;
            
            
            //console.log(player.body.velocity.x+', '+pXV);

            //玩家周遭判定跟隨
            playerSuround.setVelocityX(player.body.velocity.x);
            playerSuround.setVelocityY(player.body.velocity.y);
            playerSuround.x = player.x;
            playerSuround.y = player.y;           
            
            //玩家周遭san值
            if(san>0)
            {
                san-=20;
            }

            if(san<=150)
            {
                SharkBreath.pause();
                Pl = 0;
            }

            //console.log(playerSuround.y,player.y);
            
            

            if(gameOver == true)
            {
               
                BackgroundMusic.pause(); 
            }

            //暫存水平速度與滑動
            if(tempVX>=60 || tempVX<=-60)
            {
                easingVX = (0-tempVX)/120;
                tempVX+=easingVX;
            }
            
            if(tempVX<60 && tempVX>=-60)
            {
                easingVX = (0-tempVX)/12;
                tempVX+=easingVX;
            }

            if(cursors.left.isUp  && player.body.touching.down )
            {
                easingVX = (0-tempVX)/10;
                tempVX+=easingVX;
            }

            
            
            //人物左右移動，地面

            if(cursors.left.isDown && player.body.touching.down  )
            {
                player.setVelocityX(-200);
                player.anims.play('left',true);
                tempVX = -200;
                playerF.x = player.x;
                playerF.y = player.y+25;
                //SharkSteps.pause();
                
                

            }
            else if(cursors.right.isDown && player.body.touching.down )
            {
                player.setVelocityX(200);
                player.anims.play('right',true);
                tempVX = 200;
                playerF.x = player.x;
                playerF.y = player.y+25;
                //SharkSteps.pause();
            }
            
            //人物水平速度設定，離地
            else 
            {
                player.setVelocityX(tempVX);
                player.anims.play('turn');
                playerF.x = -100;
                playerF.y = -100;
                playerS.x = -100;
                playerS.y = -100;

                SharkSteps.play();
            }
            
            //人物地面彈跳
            if(cursors.up.isDown && player.body.touching.down )
            {
                player.setVelocityY(-400);
                SharkJump.play();
            }
           
            //人物牆面彈跳
            if(cursors.up.isDown && player.body.touching.left && pick == 0)
            {
                player.setVelocityY(-200);
                player.setVelocityX(140);
                tempVX = 140;

                playerF.x = player.x;
                playerF.y = player.y+25;

                SharkJump.play();
            }
            if(cursors.up.isDown && player.body.touching.right && pick == 0)
            {
                player.setVelocityY(-200);
                player.setVelocityX(-140);
                tempVX = -140;

                playerF.x = player.x;
                playerF.y = player.y+25;

                SharkJump.play();

            }

            //doubleJump
            if(player.body.touching.none)
            {
                pick = 0;
            }
            
            if(player.body.touching.down || player.body.touching.left || player.body.touching.right)
            {
                doubleJump = 1;
                doubleJump2 = 1;
            }
            
            
            
            
            if(cursors.up.isDown && doubleJump == 1)
            {
                
                
                doubleJump = 0;
            }

            
            if(cursors.up.isUp && player.body.touching.none && doubleJump2 == 1)
            {
                
                doubleJump2 = 2;
            }

             
            
            if(cursors.up.isDown && cursors.right.isUp && cursors.left.isUp && player.body.touching.none && doubleJump2 == 2 && pick == 0)
            {
                player.setVelocityY(-300);
                doubleJump  = 0;
                doubleJump2 = 0;
                
                playerF.x = player.x;
                playerF.y = player.y+25;

                SharkJump.play();
            }



            if(cursors.up.isDown && cursors.right.isDown && player.body.touching.none && doubleJump2 == 2 && pick == 0)
            {
                player.setVelocityX(200);
                tempVX = 200;
                player.setVelocityY(-300);
                doubleJump  = 0;
                doubleJump2 = 0;

                playerF.x = player.x;
                playerF.y = player.y+25;

                SharkJump.play();
            }

            if(cursors.up.isDown && cursors.left.isDown && player.body.touching.none && doubleJump2 == 2 && pick == 0)
            {
                player.setVelocityX(-200);
                tempVX = -200;
                player.setVelocityY(-300);
                doubleJump  = 0;
                doubleJump2 = 0;

                playerF.x = player.x;
                playerF.y = player.y+25;

                SharkJump.play();
            }

            
            //Ground Pound
            if(cursors.down.isDown  )
            {
                player.setVelocityY(800);
                

            }
            
            //人物跳躍動畫設定
            if(pXV>2 && pYV<700 && player.body.touching.none)
            {
                player.anims.play('JumpRight',true);
            }

            if(pXV<-2 && pYV<700 && player.body.touching.none)
            {
                player.anims.play('JumpLeft',true);
            }
            
            
            //Ground Pound Animation
            if(pYV>=700)
            {
                player.anims.play('down');
                playerS.x = player.x;
                playerS.y = player.y+40;
                Aa.play();
                

            }
            if(pYV<700)
            {
                playerS.x = -300;
                playerS.y = -300;
            }

            //GameRestart
            if(gameOver)
            {
                restartText.setVisible(true);
                //console.log('Gameover,Restart Game');
                SharkSteps.pause();
                SharkBreath.pause();
                Pl = 0;
            }
        }
    </script>
    
</body>
</html>