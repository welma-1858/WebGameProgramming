<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.52.0/dist/phaser.min.js"></script>

    <style type="text/css">
        body
        {
            
            margin:0;
            padding:0;
        }

    </style>
</head>
<body>
    
    <script>
        const config = 
        {
            type   : Phaser.AUTO,
            width  : 1066,
            height : 600,
            
            

            physics: 
            {
                default: 'arcade',
                arcade : 
                {
                    gravity: {y: 500},
                    debug: false
                }
            },

            scene  : 
            {
                preload: preload,
                create : create,
                update : update
            }
        };

        const game = new Phaser.Game(config);
        //=========================================DEFINE========================================
        let platforms;
        let player;
        let cursors;
        let tempVX = 0;
        let easingVX;
        let doubleJump  = 1;
        let doubleJump2 = 0;
        
        let Castle;
        let CastleOpen;
        let UpperWall;
        //FirstAme
        let firstAme;
        
        //pTouchPlat
        let pTouchPlat = 0;
        
        //Marine
        let Marine;
        let MarineInteractiveText;

        //FourSwitch
        let FourSwitchInteractiveText1;
        let FourSwitchInteractiveText2;
        let FourSwitchInteractiveText3;
        let FourSwitchInteractiveText4;
        // let FourSwitch1;
        // let FourSwitch2;
        // let FourSwitch3;
        // let FourSwitch4;

        let FourSwitch1_Off;
        let FourSwitch2_Off;
        let FourSwitch3_Off;
        let FourSwitch4_Off;
        let FourSwitch1_On;
        let FourSwitch2_On;
        let FourSwitch3_On;
        let FourSwitch4_On;

        let turnOn = 0;
        let onOff1 = 0;
        let onOff2 = 0;
        let onOff3 = 0;
        let onOff4 = 0;

        //door 1 unlock
        let unlocked = 0;
        let unlockStage = 0;
        //cookie
        let cookieValue;
        //Ame spawn 
        let AmeSpawnTimer = 0;
        let AmeCount = 2;
        
        //Marine Comunication
        let changeTimer = 0;
        let talkStage = 0;
        let paragraph;
        let isTalking = 0;
        //Instructions
        let restartText;
        let lockText1;
        let turText1;
        let turText2;
        let turText3;
        let DoorInteractiveText;
        let GoInstuction;

        //tur situation
        let firstDoubleJump = 0;
        let firstWallJump = 0;

        let check = 0;

        //星星與分數
        let stars;
        let pick = 0;
        let score = 0;
        let pickedStar = 0;
        let scoreText;

        //炸彈
        let bombs;
        let gameOver = false;

        //玩家腳底座標
        let playerF;
        let playerS;

        //玩家即時Y速度計算器
        let pY1;
        let pY2;
        let pYV;

        //玩家即時X速度計算器
        let pX1;
        let pX2;
        let pXV;

        //玩家周遭判定器
        let playerSuround;
        let san = 0;
        let Pl = 0;

        //WASD
        let W;
        let A;
        let S;
        let D;

        //Interactive
        let E;
        //Pound Shaking
        let pound = 0;
        //=========================================PRELOAD==========================================
        function preload()
        {
            

            //__________________Enviroment Element_____________________
            this.load.image('sky','assets/sky2.png');
            this.load.image('UpperWall','assets/UpperWall.png');
            this.load.image('LowerWall','assets/LowerWall.png');
            this.load.image('Castle','assets/Castle.png');
            this.load.image('CastleOpen','assets/CastleOpen.png');
            this.load.image('CastleMidPlat','assets/CastleMidPlat.png');
            this.load.image('CastleRightPlat','assets/CastleRightPlat.png');
            this.load.image('ground','assets/platform_ice.png');
            this.load.image('extendGround','assets/groundExtend.png')
            this.load.image('wall','assets/platform_ice_2.png');
            this.load.image('Marine','assets/Marine.png');
            //________________________Item_____________________________
            this.load.image('star','assets/star.png');

            this.load.image('Switch_1_Off','assets/Switch_1_Off.png');
            this.load.image('Switch_2_Off','assets/Switch_2_Off.png');
            this.load.image('Switch_3_Off','assets/Switch_3_Off.png');
            this.load.image('Switch_4_Off','assets/Switch_4_Off.png');
            this.load.image('Switch_1_On','assets/Switch_1_On.png');
            this.load.image('Switch_2_On','assets/Switch_2_On.png');
            this.load.image('Switch_3_On','assets/Switch_3_On.png');
            this.load.image('Switch_4_On','assets/Switch_4_On.png');
            
            //___________________Visual Effect_________________________
            this.load.image('step','assets/Fish.png');
            this.load.image('spear','assets/Gura_spear.png');

            
            //______________________Sound Effect_______________________
            this.load.audio("A"     ,['assets/Gura_a.mp3']);
            this.load.audio("Music" ,['assets/Background_2.mp3']);
            this.load.audio("Shout" ,['assets/Gura_shout.mp3']);
            this.load.audio("Win"   ,['assets/Ejected.mp3']);
            this.load.audio("Moving",['assets/FootStep.mp3']);
            this.load.audio("Jump"  ,['assets/JumpSound.mp3']);
            this.load.audio("NewAme",['assets/AreYouWinning.mp3']);
            this.load.audio("Breath",['assets/SharkBreath.mp3']);
            this.load.audio("DoorOpen",['assets/open.mp3']);
            this.load.audio("Ahoy",['assets/GuraAhoy.mp3']);
            this.load.audio("Blocked",['assets/openBlocked.mp3']);
            this.load.audio("Blizzard",['assets/Blizzard_Sound_Effects.mp3']);
            this.load.audio("SwitchPress",['assets/Switch_Press.mp3']);
            this.load.audio("SwitchWrong",['assets/Switch_Wrong.mp3']);
            
            //________________________Sprite_____________________________
            this.load.spritesheet('dude','assets/Gura_add.png',
            {frameWidth: 32, frameHeight: 48});

            //Ame spriteSheet
            this.load.spritesheet('Ame','assets/Ame_add.png',
            {frameWidth: 28, frameHeight: 28});
            this.load.spritesheet('AmeLowQ','assets/Ame_LowQ.png',
            {frameWidth: 26, frameHeight: 45});

            //玩家周遭範圍
            this.load.spritesheet('Suround','assets/Suround.png',
            {frameWidth:140,frameHeight:100});
        }
        
        
        
        //=========================================CREATE========================================
        function create()
        {
            
            //____________________Sound Effect_____________________________
            Aa = this.sound.add("A",{loop: false}); 
            SharkShout = this.sound.add("Shout",{loop:false});
            SharkWin = this.sound.add("Win",{loop:false});
            
            Amespawn = this.sound.add("NewAme",{loop:false});
            
            SwitchPress = this.sound.add("SwitchPress",
            {
                loop:false,
                volume:1
            });

            SwitchWrong = this.sound.add("SwitchWrong",
            {
                loop:false,
                volume:1
            });

            Blizzard = this.sound.add("Blizzard",
            {
                loop:true,
                volume:0.4
            });
            
            SharkBreath = this.sound.add("Breath",
            {
                loop:true,
                volume:0.4
            });
            
            SharkJump = this.sound.add("Jump",
            {
                loop:false,
                rate:1.2,
                volume:0.4
            });


            SharkSteps = this.sound.add("Moving",
            {
                loop:true,
                rate:0.85,
                volume:0.15
            });

            
            DoorOpen = this.sound.add("DoorOpen",
            {
                loop:false,
                rate:1.3,
                volume:0.6
            });
            
            Ahoy = this.sound.add("Ahoy",
            {
                loop:false,
                rate:1,
                volume:0.3
            });

            Blocked = this.sound.add("Blocked",
            {
                loop:false,
                rate:1,
                volume:0.6
            });

            BackgroundMusic = this.sound.add("Music",
            {
                loop:true,
                volume:0.8
            
            });
            
            Blizzard.play();
            BackgroundMusic.play();

            //_________________________Timer______________________________
            this.time.addEvent(
                {
                    delay:17,
                    callback:()=>
                    {
                        pY2 = pY1;
                        pX2 = pX1;

                    },   
                    loop:true
                });
            
            
            //_______________________Enviroment___________________________
            
            this.add.image(400,300,'sky').setScale(1.9,1.2).setScrollFactor(0.1);
            Castle = this.add.image(2000,260,'Castle').setScale(0.7);
            CastleOpen = this.add.image(2000,260,'CastleOpen').setScale(0.7).setAlpha(0);
                
            platforms = this.physics.add.staticGroup();

            platforms.create(1500,20,'wall')

            //Wall
            this.add.image(600,245,'LowerWall').setScale(0.7);
            
            //Extend ground
            this.add.image(250,650,'extendGround').setScale(1.2,1.4);
            this.add.image(750,650,'extendGround').setScale(1,1.4);
            this.add.image(1250,650,'extendGround').setScale(1,1.4);
            this.add.image(1750,650,'extendGround').setScale(1,1.4);
            this.add.image(2250,650,'extendGround').setScale(1,1.4);

            //ground platforms
            platforms.create(180,588,'ground')
            platforms.create(560,588,'ground')
            platforms.create(800,588,'ground')
            platforms.create(1040,588,'ground')
            platforms.create(1280,588,'ground')
            platforms.create(1520,588,'ground')
            platforms.create(1760,588,'ground')
            platforms.create(2000,588,'ground')
            platforms.create(1935,218,'CastleMidPlat').setScale(0.7).refreshBody();
            platforms.create(2172,426,'CastleRightPlat').setScale(0.7).refreshBody();
            
            //float platforms
            platforms.create(1300,400,'ground')
            platforms.create(770,250,'ground').setScale(0.6,1).refreshBody();
            platforms.create(1450,220,'ground')
            
            
            platforms.create(1050,200,'wall').setScale(0.5).refreshBody();
            
            platforms.create(600,200,'wall').setScale(2,1).refreshBody().setVisible(false);
            platforms.create(600,320,'wall').setScale(2,1).refreshBody().setVisible(false);
            //Marine
            Marine = this.add.image(423,527,'Marine');
            //______________________Switches_____________________________
            FourSwitch1_Off = this.add.image(910,540,'Switch_1_Off').setScale(0.7);
            FourSwitch1_On  = this.add.image(910,540,'Switch_1_On').setScale(0.7).setVisible(false);
            FourSwitch2_Off = this.add.image(770,202,'Switch_2_Off').setScale(0.7);
            FourSwitch2_On  = this.add.image(770,202,'Switch_2_On').setScale(0.7).setVisible(false);
            FourSwitch3_Off = this.add.image(1300,352,'Switch_3_Off').setScale(0.7);
            FourSwitch3_On  = this.add.image(1300,352,'Switch_3_On').setScale(0.7).setVisible(false);
            FourSwitch4_Off = this.add.image(1660,540,'Switch_4_Off').setScale(0.7);
            FourSwitch4_On  = this.add.image(1660,540,'Switch_4_On').setScale(0.7).setVisible(false);



            //______________________星星設定與碰撞物理___________________________________
            // stars = this.physics.add.group(
            //     {
            //         key:'star',
            //         repeat:11,
            //         setXY:
            //         {
            //             x:722,
            //             y:0,
            //             stepX:70
            //         }

            //     });
            // stars.children.iterate(function(child)
            // {
            //     child.setBounceY(Phaser.Math.FloatBetween(0.4,0.8));
            // });

            //______________________________炸彈設定與碰撞物理_____________________________
            bombs = this.physics.add.group(
                {
                    key:'Ame',
                    repeat:1,
                    setXY:
                    {
                        x:730,
                        y:0,
                        stepX:100
                    }
                })
            
            
            bombs.children.iterate(function(child)
            {
                child.setBounce(1);
                child.setVelocity(Phaser.Math.Between(-250,250),0);
                child.setCollideWorldBounds(true);
                child.body.gravity.y=-350;
                child.allowGravity = true;
                
                
                //let distW = Phaser.Math.BetweenPoints(player.x-child.x,player.y-child.y);
            });

            
            firstAme = bombs.create(560,548,'Ame');
            firstAme.setBounce(1);
            firstAme.setCollideWorldBounds(true);
            firstAme.allowGravity = true;

            //bombs.setBounce(1);
            //bombs.setCollideWorldBounds(true);
            
            //腳步特效
            let particles = this.add.particles('step');
            let emitter = particles.createEmitter(
                {
                    speed    : 30,
                    scale    : {start: 1.1,end: 0},
                    alpha    : {start: 1,end: 0.4},

                    accelerationX:-200,
                   
                    
                    blendMode: 'SCREEN'
                });
            
            //三叉戟特效
            let particles2 = this.add.particles('spear');
            let emitter2 = particles2.createEmitter(
                {
                    speed    : 200,
                    scale    : {start: 0.6,end: 0},
                    alpha    : {start: 1,end: 0.4},

                    accelerationX:-400,
                    accelerationY:300,

                    blendMode: 'SCREEN'
                })
            
            
            
            //玩家周遭
            playerSuround = this.physics.add.sprite(100,450,'Suround');
            playerSuround.setBounce(false);
            playerSuround.setCollideWorldBounds(false);
            playerSuround.setGravity(false);
            playerSuround.setVisible(false);
            
            playerSuround.setImmovable();

            //玩家與地圖碰撞
            player = this.physics.add.sprite(100,450,'dude');
            this.cameras.main.setBounds(0,0,2200,700);
            this.cameras.main.startFollow(player);
            this.cameras.main.setSize(1066, 600);
            this.cameras.main.setLerp(0.07,0.07);
            this.cameras.main.setZoom(1.4);

            player.setBounce(0);
            player.setCollideWorldBounds(true);
            this.physics.world.bounds.width=2200;
            this.physics.world.bounds.height=700;

            //玩家腳底
            playerF = this.add.sprite(100,450,'dude');
            playerF.setVisible(false);

            playerS = this.add.sprite(100,450,'dude');
            playerS.setVisible(false);

            //________________________________Upper scene_______________________________________
            UpperWall = this.add.image(600,245,'UpperWall').setScale(0.7);
            
            //_________________________________UI Below_____________________________________________
            
            
            //DoorInteractiveText
            DoorInteractiveText = this.add.text(1930,400,'E',{font:'36px Arial Black',backgroundColor:'rgba(51,68,102,0.8)',color:'white',fixedWidth:28});
            DoorInteractiveText.scene.tweens.add(
            {
                targets: DoorInteractiveText,
                scaleX:1,
                scaleY:1,
                alpha:0,
                ease:'Linear',
                duration:600,
                repeat:-1,
                yoyo:true
            });
            
            //FourSwitchInteractiveText
            FourSwitchInteractiveText1 = this.add.text(900,470,'E',{font:'36px Arial Black',backgroundColor:'rgba(51,68,102,0.8)',color:'white',fixedWidth:28});
            FourSwitchInteractiveText1.scene.tweens.add(
            {
                targets: FourSwitchInteractiveText1,
                scaleX:1,
                scaleY:1,
                alpha:0,
                ease:'Linear',
                duration:600,
                repeat:-1,
                yoyo:true
            });

            //FourSwitch1 = this.add.text(860,530,'  Off',{font:'36px Arial Black',backgroundColor:'rgba(0,0,0,0.4)',color:'white',fixedWidth:105});
            

            FourSwitchInteractiveText2 = this.add.text(760,132,'E',{font:'36px Arial Black',backgroundColor:'rgba(51,68,102,0.8)',color:'white',fixedWidth:28});
            FourSwitchInteractiveText2.scene.tweens.add(
            {
                targets: FourSwitchInteractiveText2,
                scaleX:1,
                scaleY:1,
                alpha:0,
                ease:'Linear',
                duration:600,
                repeat:-1,
                yoyo:true
            });

            //FourSwitch2 = this.add.text(720,192,'  Off',{font:'36px Arial Black',backgroundColor:'rgba(0,0,0,0.4)',color:'white',fixedWidth:105});

            FourSwitchInteractiveText3 = this.add.text(1290,282,'E',{font:'36px Arial Black',backgroundColor:'rgba(51,68,102,0.8)',color:'white',fixedWidth:28});
            FourSwitchInteractiveText3.scene.tweens.add(
            {
                targets: FourSwitchInteractiveText3,
                scaleX:1,
                scaleY:1,
                alpha:0,
                ease:'Linear',
                duration:600,
                repeat:-1,
                yoyo:true
            });

            //FourSwitch3 = this.add.text(1250,342,'  Off',{font:'36px Arial Black',backgroundColor:'rgba(0,0,0,0.4)',color:'white',fixedWidth:105});

            FourSwitchInteractiveText4 = this.add.text(1650,470,'E',{font:'36px Arial Black',backgroundColor:'rgba(51,68,102,0.8)',color:'white',fixedWidth:28});
            FourSwitchInteractiveText4.scene.tweens.add(
            {
                targets: FourSwitchInteractiveText4,
                scaleX:1,
                scaleY:1,
                alpha:0,
                ease:'Linear',
                duration:600,
                repeat:-1,
                yoyo:true
            });

            //FourSwitch4 = this.add.text(1610,530,'  Off',{font:'36px Arial Black',backgroundColor:'rgba(0,0,0,0.4)',color:'white',fixedWidth:105});

            //Marine InteractiveText
            MarineInteractiveText = this.add.text(410,380,'E',{font:'36px Arial Black',backgroundColor:'rgba(51,68,102,0.8)',color:'white',fixedWidth:28});
            MarineInteractiveText.scene.tweens.add(
            {
                targets: MarineInteractiveText,
                scaleX:1,
                scaleY:1,
                alpha:0,
                ease:'Linear',
                duration:600,
                repeat:-1,
                yoyo:true
            });

            //GO Instruction
            GoInstuction = this.add.text(750,250,'GO >>',{font:'42px Arial Black',color:'white',fixedWidth:200}).setScrollFactor(0).setAlpha(1);
            GoInstuction.scene.tweens.add(
            {
                targets: GoInstuction,
                scaleX:1,
                scaleY:1,
                alpha:0,
                ease:'Linear',
                duration:500,
                repeat:-1,
                yoyo:true
            });
            //Marine Talk
            paragraph = this.add.text(340,430,'        Help... \nSomeone help',{font:'20px Arial Black',backgroundColor:'rgba(0,0,0,0.4)',color:'white',fixedWidth:200});            
            //lock 1
            //lockText1 = this.add.text(1870,470,'CollectStars\n      0/24',{font:'24px Arial Black',backgroundColor:'rgba(0,0,0,0.4)',color:'white',fixedWidth:200});
            
            //tur Text
            turText1 = this.add.text(0,400,'         Press\n       "WASD"  \n to move around',{font:'24px Arial Black',backgroundColor:'rgba(0,0,0,0.4)',color:'white',fixedWidth:220});        
            turText2 = this.add.text(920,360,'Press "W" twice\n to double jump',{font:'18px Arial Black',color:'white',fixedWidth:200}).setAlpha(0);
            turText3 = this.add.text(1070,230," <<  \nIt's able \nto wall jump",{font:'18px Arial Black',color:'white',fixedWidth:200}).setAlpha(0);
            

            //計分
            scoreText = this.add.text(160,90,'Score:0',{font:'32px Arial Black',backgroundColor:'rgba(0,0,0,0.4)',color:'white',fixedWidth:200}).setScrollFactor(0);

            //Restart
            restartText = this.add.text(config.width/2-100,config.height/2-40,'Restart',
            {
                font:'40px Arial Black',
                color:'white',
                stroke:'red',
                padding:10,
                backgroundColor:'rgba(0,0,0,0.4)'
            }).setScrollFactor(0);
            
            restartText.visible = false;
                
            restartText.setInteractive().on('pointerdown',(pointer,localX,localY,event)=>
            {
                onOff1 = 0;
                onOff2 = 0;
                onOff3 = 0;
                onOff4 = 0;
                talkStage = 0;
                unlocked = 0;
                score = 0;
                pickedStar = 0;
                firstDoubleJump = 0;
                firstWallJump = 0;
                gameOver = false;
                this.scene.restart();
            });
            //this.cameras.main.ignore([scoreText,restartText]);

            //_________________________________UI Ends________________________________________________

            //Gura animation set
            this.anims.create(
                {
                    key: 'left',
                    frames: this.anims.generateFrameNumbers('dude',{start: 0,end: 3}),
                    frameRate: 12,
                    repeat: -1
                });

            this.anims.create(
            {
                key: 'turn',
                frames:[{key: 'dude',frame: 4}],
                frameRate: 20
            });

            this.anims.create(
                {
                    key: 'right',
                    frames: this.anims.generateFrameNumbers('dude',{start: 5,end: 8}),
                    frameRate:12,
                    repeat:-1
                });
            
            this.anims.create(
                {
                    key:'down',
                    frames:[{key:'dude',frame:9}],
                    frameRate:1
                })

            this.anims.create(
                {
                    key:'JumpLeft',
                    frames:[{key:'dude',frame:2}],
                    frameRate:12,
                    repeat:-1
                })
            
            this.anims.create(
                {
                    key:'JumpRight',
                    frames:[{key:'dude',frame:5}],
                    frameRate:12,
                    repeat:-1
                })

            //Ame animation set
            this.anims.create(
                {
                    key: 'AmeLeft',
                    frames:[{key:'Ame',frame:4}],
                    frameRate:20

                })
            
            this.anims.create(
                {
                    key: 'AmeRight',
                    frames:[{key:'Ame',frame:5}],
                    frameRate:20
                })
            
            this.anims.create(
                {
                    key: 'AmeLeftRotate',
                    frames: this.anims.generateFrameNumbers('Ame',{start: 3,end: 0}),
                    frameRate:8,
                    repeat:-1
                })

            this.anims.create(
                {
                    key: 'AmeRightRotate',
                    frames: this.anims.generateFrameNumbers('Ame',{start: 6,end: 9}),
                    frameRate:8,
                    repeat:-1
                })

            //方向鍵操控
            cursors = this.input.keyboard.createCursorKeys();

            // this.cursors = this.input.keyboard.addKeys(
            // {
            //     up   :Phaser.Input.Keyboard.KeyCodes.W,
            //     down :Phaser.Input.Keyboard.KeyCodes.S,
            //     left :Phaser.Input.Keyboard.KeyCodes.A,
            //     right:Phaser.Input.Keyboard.KeyCodes.D
            // });

           //W A S D操控
            
            W = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.W);
            A = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.A);
            S = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.S);
            D = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.D);
            
            E = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.E);

            
            //Test Collider
            this.physics.add.collider(player,platforms,playerTouchPlat,null,this);
            
            //玩家、星星和地板碰撞
            //this.physics.add.collider(stars,platforms);
            

            //撿星星
            //this.physics.add.overlap(player,stars,collectStar,null,this);
            
            // //Ame靠近玩家
            this.physics.add.overlap(playerSuround,bombs,GuraBreath,null,this);
           
            
            //炸彈碰撞
            this.physics.add.collider(bombs,platforms);
            
            this.physics.add.collider(player,bombs,hitBomb,null,this);
            
            //Ame碰撞轉向
            this.physics.add.collider(bombs,platforms,AmeAnimation,null,this);

            emitter2.startFollow(playerS);
            
            
            emitter.startFollow(playerF);

            

            //下雪特效
            let particles3 = this.add.particles('step');
            let emitter3 = particles3.createEmitter(
                {
                    x        : 100,
                    y        : -50,
                    
                    speed    : 400,
                    scale    : {start: 0.7,end: 0.2},
                    alpha    : {start: 0.4,end: 0},

                    rotate: Phaser.Math.Between(0,360),

                    accelerationX:-200,
                    accelerationY:-40,
                    lifespan:{min:2500,max:3500},


                    blendMode: 'SCREEN'
                }).setScrollFactor(0);

            let particles4 = this.add.particles('step');
            let emitter4 = particles4.createEmitter(
                {
                    x        : 250,
                    y        : -50,
                    
                    speed    : 400,
                    scale    : {start: 0.6,end: 0},
                    alpha    : {start: 0.4,end: 0},

                    rotate: Phaser.Math.Between(0,360),

                    accelerationX:-200,
                    accelerationY:-40,
                    lifespan:{min:2500,max:3500},


                    blendMode: 'SCREEN'
                }).setScrollFactor(0);

                let particles5 = this.add.particles('step');
            let emitter5 = particles5.createEmitter(
                {
                    x        : 400,
                    y        : -50,
                    
                    speed    : 400,
                    scale    : {start: 0.7,end: 0},
                    alpha    : {start: 0.4,end: 0},

                    rotate: Phaser.Math.Between(0,360),

                    accelerationX:-200,
                    accelerationY:-40,
                    lifespan:{min:2500,max:3500},
                    


                    blendMode: 'SCREEN'
                }).setScrollFactor(0);

                let particles6 = this.add.particles('step');
            let emitter6 = particles6.createEmitter(
                {
                    x        : 550,
                    y        : -50,
                    
                    speed    : 400,
                    scale    : {start: 0.6,end: 0},
                    alpha    : {start: 0.4,end: 0},

                    rotate: Phaser.Math.Between(0,360),

                    accelerationX:-200,
                    accelerationY:-40,
                    lifespan:{min:2500,max:3500},


                    blendMode: 'SCREEN'
                }).setScrollFactor(0);

                let particles7 = this.add.particles('step');
            let emitter7 = particles7.createEmitter(
                {
                    x        : 700,
                    y        : -50,
                    
                    speed    : 400,
                    scale    : {start: 0.7,end: 0},
                    alpha    : {start: 0.4,end: 0},

                    rotate: Phaser.Math.Between(0,360),

                    accelerationX:-200,
                    accelerationY:-40,
                    lifespan:{min:2500,max:3500},


                    blendMode: 'SCREEN'
                }).setScrollFactor(0);

                let particles8 = this.add.particles('step');
            let emitter8 = particles8.createEmitter(
                {
                    x        : 850,
                    y        : -50,
                    
                    speed    : 400,
                    scale    : {start: 0.6,end: 0},
                    alpha    : {start: 0.4,end: 0},

                    rotate: Phaser.Math.Between(0,360),

                    accelerationX:-200,
                    accelerationY:-40,
                    lifespan:{min:2500,max:3500},


                    blendMode: 'SCREEN'
                }).setScrollFactor(0);
            

        }

        //=========================================FUNCTIONS========================================
        
        //Test func
        function playerTouchPlat(player,platforms)
        {
            pTouchPlat = 1;
        }
        
        function getCookie()
        {
            alert("Cookie is" + cookieValue);
        }
        
        function paragraph_Change()
        {
            
            changeTimer = 0;
            if(talkStage == 1)
            {
                paragraph.setText('There are Ames \n Everywhere');
                Ahoy.play();

            }
            if(talkStage == 2)
            {
                paragraph.setText('They will Ground \n Pound Everyone');
                
                
            }
            if(talkStage == 3)
            {
                paragraph.setText('You need to  \n Pound them first');
                
            }
            if(talkStage == 4)
            {
                paragraph.setBackgroundColor('rgba(0,0,0,0)').setText('Press"D+W"\nThen press"S"');
                
            }

            
            
        }

        //FourSwitch_change
        function FourSwitch_change1()
        {
            
            // changeTimer1 = 0;
            FourSwitchInteractiveText1.setVisible(false);
            if(onOff1 = 1)
            {
                //FourSwitch1.setText('  On');
                FourSwitch1_On.setVisible(true);
                FourSwitch1_Off.setVisible(false);
                SwitchPress.play();
            }

        }

        function FourSwitch_change2()
        {
            
            // changeTimer2 = 0;
            FourSwitchInteractiveText2.setVisible(false);
            if(onOff2 == 1)
            {
                //FourSwitch2.setText('  On');
                FourSwitch2_On.setVisible(true);
                FourSwitch2_Off.setVisible(false);
                SwitchPress.play();
            }

        }

        function FourSwitch_change3()
        {
            
            // changeTimer3 = 0;
            FourSwitchInteractiveText3.setVisible(false);
            if(onOff3 == 1)
            {
                //FourSwitch3.setText('  On');
                FourSwitch3_On.setVisible(true);
                FourSwitch3_Off.setVisible(false);
                SwitchPress.play();
            }

        }

        function FourSwitch_change4()
        {
            
            // changeTimer4 = 0;
            FourSwitchInteractiveText4.setVisible(false);
            if(onOff4 == 1)
            {
                //FourSwitch4.setText('  On');
                FourSwitch4_On.setVisible(true);
                FourSwitch4_Off.setVisible(false);
                SwitchPress.play();
            }

        }

        function mistake()
        {
            FourSwitchInteractiveText1.setVisible(true);
            onOff1 = 0;
            //FourSwitch1.setText('  Off');
            FourSwitch1_On.setVisible(false);
            FourSwitch1_Off.setVisible(true);
            FourSwitchInteractiveText2.setVisible(true);
            onOff2 = 0;
            //FourSwitch2.setText('  Off');
            FourSwitch2_On.setVisible(false);
            FourSwitch2_Off.setVisible(true);
            FourSwitchInteractiveText3.setVisible(true);
            onOff3 = 0;
            //FourSwitch3.setText('  Off');
            FourSwitch3_On.setVisible(false);
            FourSwitch3_Off.setVisible(true);
            FourSwitchInteractiveText4.setVisible(true);
            onOff4 = 0;
            //FourSwitch4.setText('  Off');
            FourSwitch4_On.setVisible(false);
            FourSwitch4_Off.setVisible(true);

            SwitchWrong.play();
        }
        
        // function lockText1_Open()
        // {
        //     lockText1.scene.tweens.add(
        //     {
        //         targets: lockText1,
        //         scaleX:1,
        //         scaleY:1,
        //         alpha:1,
        //         ease:'Linear',
        //         duration:300,
        //         repeat:0,
        //         yoyo:false
        //     });
        // }

        // function lockText1_Close()
        // {
        //     lockText1.scene.tweens.add(
        //     {
        //         targets: lockText1,
        //         scaleX:0,
        //         scaleY:0,
        //         alpha:0,
        //         ease:'Linear',
        //         duration:300,
        //         repeat:0,
        //         yoyo:false
        //     });
        // }
        
        function turText1_Close()
        {
            turText1.scene.tweens.add(
            {
                targets: turText1,
                scaleX:1,
                scaleY:1,
                alpha:0,
                ease:'Linear',
                duration:300,
                repeat:0,
                yoyo:false,
                onComplete:()=>
                {
                    turText2_Open();
                }
            });
        }
        
        function turText2_Open()
        {
            turText2.scene.tweens.add(
            {
                targets: turText2,
                scaleX:1,
                scaleY:1,
                alpha:1,
                ease:'Linear',
                duration:300,
                repeat:0,
                yoyo:false
            });
        }

        function turText2_Close()
        {
            turText2.scene.tweens.add(
            {
                targets: turText2,
                scaleX:1,
                scaleY:1,
                alpha:0,
                ease:'Linear',
                duration:300,
                repeat:0,
                yoyo:false,
                onComplete:()=>
                {
                    turText3_Open();
                }
            });
        }
        
        function turText3_Open()
        {
            turText3.scene.tweens.add(
            {
                targets: turText3,
                scaleX:1,
                scaleY:1,
                alpha:1,
                ease:'Linear',
                duration:300,
                repeat:0,
                yoyo:false
            });
        }

        function turText3_Close()
        {
            turText3.scene.tweens.add(
            {
                targets: turText3,
                scaleX:1,
                scaleY:1,
                alpha:0,
                ease:'Linear',
                duration:300,
                repeat:0,
                yoyo:false
            });
        }

        

        function GoInstuction_Close()
        {
            GoInstuction.setAlpha(0);
        }

        //When enemy approching, Gura breath hardly
        function GuraBreath(playerSuround,bombs)
        {
            san = 2000;
            
            
            if(san>0 & Pl==0)
            {
                SharkBreath.play();
                Pl=1;
            } 
        
              
        }
        
        function unlockDoor(bomb)
        {
            //bombs.clear();
            bombs.children.iterate(function(child)
            {
                child.disableBody(true,true);
            });
            unlocked+=0.01;

            
            
        }
        
        

        // function collectStar(player,star)
        // {
        //     pick = 1;
        //     star.disableBody(true,true);
        //     pickedStar+=1;
        //     score +=10;
        //     scoreText.setText('Score:'+score);
        //     lockText1.setText('CollectStars\n'+'      '+pickedStar+'/24',{font:'24px Arial Black',backgroundColor:'rgba(0,0,0,0.4)',color:'white',fixedWidth:200});
        //     if(stars.countActive(true) === 0 && pickedStar<24)
        //     {
        //         stars.children.iterate(function(child)
        //         {
        //             child.enableBody(true,child.x,0,true,true);
        //         });
                
        //         AmeSpawnTimer = 0;
                
        //         if(AmeCount<4)
        //         {
        //             let x = (player.x < 1100) ? Phaser.Math.Between(1100,1500) : Phaser.Math.Between(700,1100);
        //             let bomb = bombs.create(x,16,'Ame');
        //             bomb.setBounce(1);
        //             bomb.setCollideWorldBounds(true);
        //             bomb.setVelocity(Phaser.Math.Between(-200,200),20);
        //             bomb.allowGravity = false;
                    
        //             AmeCount +=1;
        //             Amespawn.play();   
        //         }           
        //     }        
        // }

        function AmeAnimation()
        {
           
        }

        function hitBomb(player,bomb)
        {
            if(pYV<700)
            {
                this.physics.pause();
                player.setTint(0xff0000);
                player.anims.play('turn');
                gameOver = true;
                SharkShout.play();  
            }

            if(pYV>=700)
            {
                score +=100;
                scoreText.setText('Score:'+score);
                bomb.disableBody(true,true);
                SharkWin.play();
                SharkBreath.pause();
                this.cameras.main.shake(300,0.005,false,null,null);
                AmeCount -=1 ;
                
            }
            
        }


        //=========================================UPDATES========================================

        function update()
        {
            //console.log(player.body.velocity.x);
            
            //playerF.x = player.x;
            //playerF.y = player.y+30;
            
            //console.log(san);
            //console.log(pXV);
            //console.log(playerSuround.x,playerSuround.y);
            //console.log(player.y);
            
            //_________Test Area__________
            
            
            
            
            //_______End of Test Area______
            
            //______________Wall Jump Debug_________________
            if(pTouchPlat == 1)
            {
                pick = 0;
            }
            
            //_________________TEST Temp VX adjust_________________________
            if(A.isDown )
            {
                tempVX-=1.5;
                
            }

            if(D.isDown)
            {
                tempVX+=1.5;
            }

            //_________________________ Sync score with cookie_____________________
            document.cookie = score;
            
            cookieValue = document.cookie;
            
            
            //___________________________Marine tutorial____________________________
            if(talkStage == 2)
            {
                this.cameras.main.pan(560,548,500,'Power2');
                UpperWall.setAlpha(0.3);
            }
            
            if(talkStage == 3)
            {
                this.cameras.main.pan(423,527,500,'Power2');
                UpperWall.setAlpha(1);
            }
            
            if(talkStage == 4)
            {
                // this.cameras.main.startFollow(player);
                MarineInteractiveText.setVisible(false);
                talkStage = 5;

                
            }


            if (changeTimer >0.6)
            {
                isTalking = 0;
            }
            
            if(player.x>340 && player.x<480 && player.y>400)
            {
                changeTimer += 0.01;
            }
            if(player.x>340 && player.x<480 && player.y>400 && E.isDown && isTalking == 0)
            {
                talkStage += 1;
                isTalking =1;
                paragraph_Change();
                
            } 
            
            if(player.x<=340 || player.x>=480 || player.y<500 )
            {
                changeTimer = 0;
            }

            //turn
            if(( E.isDown) && player.body.touching.down && turnOn == 0)
            {
                
                turnOn = 1;
            }

            
            if(( E.isUp) && player.body.touching.down && turnOn == 1)
            {
                
                turnOn = 0;
            }

            //turnOn1
            if(player.x>860 && player.x<965 && player.y>500 && player.y<550 && E.isDown)
            {
                onOff1 = 1;
                // turnOn =1;
                FourSwitch_change1();
                
            } 

            //turnOn2
            if(player.x>720 && player.x<825 && player.y>200 && player.y<250 && E.isDown)
            {
                onOff2 = 1;
                // turnOn =1;
                FourSwitch_change2();
                
            } 

            //turnOn3}
            if(player.x>1250 && player.x<1355 && player.y>350 && player.y<400 && E.isDown)
            {
                onOff3 = 1;
                // turnOn =1;
                FourSwitch_change3();
                
            } 
            
            //turnOn4
            if(player.x>1610 && player.x<1715 && player.y>500 && player.y<550 && E.isDown)
            {
                onOff4 = 1;
                // turnOn =1;
                FourSwitch_change4();
                
            } 
            
            //mistake
            if(onOff1 == 0 && onOff2 == 1)
            {
                mistake();
            }

            if(onOff1 == 0 && onOff3 == 1)
            {
                mistake();
            }

            if(onOff1 == 0 && onOff4 == 1)
            {
                mistake();
            }

            if(onOff1 == 1 && onOff2 == 0 && onOff3 == 1)
            {
                mistake();
            }

            if(onOff1 == 1 && onOff2 == 0 && onOff4 == 1)
            {
                mistake();
            }

            if(onOff1 == 1 && onOff2 == 1 && onOff3 == 0 && onOff4 == 1)
            {
                mistake();
            }

            if(firstAme.active == false)
            {
                talkStage = 5;
                paragraph.setBackgroundColor('rgba(0,0,0,0.4)').setText('  Go to Castle \n and stop them');
                MarineInteractiveText.setVisible(false);
            
            }

            if(player.x>750)
            {
                paragraph.setVisible(false);
            }
            
            
            //_____________________Wall Jump EasterEgg__________________________
            if(unlockStage == 3 && firstWallJump == 0)
            {
                turText3.setText('Wall Jump \n SUCKS!!!');
            }
            
            //_________________________Upper Wall Alpha__________________________
            if(player.x>460 && player.x<640 )
            {
                UpperWall.setAlpha(0.3);
            }
            if((player.x<=460 || player.x>=640) && talkStage != 2  )
            {
                UpperWall.setAlpha(1);
            }
            
            //______________________Ame Generate with timer__________________________
            AmeSpawnTimer+=0.01;
            if(AmeSpawnTimer>9.6)
            {
                if(AmeCount<4)
                {
                    let x = (player.x < 1100) ? Phaser.Math.Between(1100,1500) : Phaser.Math.Between(700,1100);
                    let bomb = bombs.create(x,16,'Ame');
                    bomb.setBounce(1);
                    bomb.setCollideWorldBounds(true);
                    bomb.setVelocity(Phaser.Math.Between(-200,200),20);
                    bomb.body.gravity.y=-350;
                    bomb.allowGravity = true;
                    AmeCount +=1;
                    Amespawn.play();  
                    
                }
                
                
                AmeSpawnTimer = 0;
            }
            
            
            //____________________Go Instructions_______________________
            if(unlockStage!=3 || (unlockStage==3 && player.x>1600))
            {
                GoInstuction_Close();
            }   
            
            //______________________lock1 animation____________________________
        
            // if(player.x>1800)
            // {
            //     lockText1_Open();
            // }

            // if(player.x<=1800)
            // {
            //     lockText1_Close();
            // }

            //_________________________tur animation____________________________
            if(player.x>200)
            {
                turText1_Close();
            }

            if(firstDoubleJump == 1)
            {
                turText2_Close();
            }

            if(firstWallJump == 1)
            {
                turText3_Close();
            }

            //_________________Unlock Animations_______________________________
            if(onOff1 == 1 && onOff2 == 1 && onOff3 == 1 && onOff4 == 1)
            {
                AmeSpawnTimer = 0;
                
                scoreText.setVisible(false);
                DoorInteractiveText.setVisible(false);
                GoInstuction.setVisible(false);
                this.cameras.main.pan(2400,400,1000,'Power2');
                BackgroundMusic.setVolume(0);
                Blizzard.setVolume(0.2);
                //this.cameras.main.zoomTo(1,1000);
                
                

                unlockDoor();        
            }

            if(unlockStage == 0 && onOff1 == 1 && onOff2 == 1 && onOff3 == 1 && onOff4 == 1)
            {
                unlockStage = 1;
                DoorOpen.play();
            }

            if(unlockStage == 1)
            {
                unlockStage = 2;
                
                this.cameras.main.shake(3000,0.005,false,null,null);
                
            }

            if(unlockStage == 2 && unlocked >= 1.8)
            {
                unlockStage = 3;
                this.cameras.main.flash(800);
                CastleOpen.setAlpha(1);

            }
            
            if(unlocked >= 3)
            {
                scoreText.setVisible(true);
                DoorInteractiveText.setVisible(true);
                GoInstuction.setVisible(true);
                this.cameras.main.startFollow(player);
                //this.cameras.main.zoomTo(1.4,1000);
                Blizzard.setVolume(0.4);
                
                
                
                unlockDoor(false);
            }

            //______________________更新玩家XY值(在60幀下)_________________________
            
            pY1 = player.y;
            pX1 = player.x;
            pYV = (pY1-pY2)/0.017;
            pXV = (pX1-pX2)/0.017;
            
            
            //console.log(player.body.velocity.x+', '+pXV);

            //玩家周遭判定跟隨
            playerSuround.setVelocityX(player.body.velocity.x);
            playerSuround.setVelocityY(player.body.velocity.y);
            playerSuround.x = player.x;
            playerSuround.y = player.y;           
            
            //玩家周遭san值
            if(san>0)
            {
                san-=20;
            }

            if(san<=150)
            {
                SharkBreath.pause();
                Pl = 0;
            }

            //console.log(playerSuround.y,player.y);
            
            

            if(gameOver == true)
            {
               
                BackgroundMusic.pause(); 
                Blizzard.pause();
            }

            //暫存水平速度與滑動
            if(tempVX>=60 || tempVX<=-60)
            {
                easingVX = (0-tempVX)/120;
                tempVX+=easingVX;
            }
            
            if(tempVX<60 && tempVX>=-60)
            {
                easingVX = (0-tempVX)/12;
                tempVX+=easingVX;
            }

            if(( A.isUp)  && player.body.touching.down )
            {
                easingVX = (0-tempVX)/10;
                tempVX+=easingVX;
            }

            
            
            //人物左右移動，地面

            if(( A.isDown) && player.body.touching.down  )
            {
                player.setVelocityX(-200);
                player.anims.play('left',true);
                tempVX = -200;
                playerF.x = player.x;
                playerF.y = player.y+25;
                //SharkSteps.pause();
                
                

            }
            else if(( D.isDown) && player.body.touching.down )
            {
                player.setVelocityX(200);
                player.anims.play('right',true);
                tempVX = 200;
                playerF.x = player.x;
                playerF.y = player.y+25;
                //SharkSteps.pause();
            }
            
            //人物水平速度設定，離地
            else 
            {
                player.setVelocityX(tempVX);
                player.anims.play('turn');
                playerF.x = -100;
                playerF.y = -100;
                playerS.x = -100;
                playerS.y = -100;

                SharkSteps.play();
            }
            
            //人物地面彈跳
            if(( W.isDown )&& player.body.touching.down )
            {
                player.setVelocityY(-400);
                SharkJump.play();
            }
           
            //人物牆面彈跳
            if(( W.isDown) && player.body.touching.left && pick == 0)
            {
                player.setVelocityY(-200);
                player.setVelocityX(140);
                tempVX = 140;

                playerF.x = player.x;
                playerF.y = player.y+25;

                SharkJump.play();

                firstWallJump = 1;
            }
            if(( W.isDown) && player.body.touching.right && pick == 0)
            {
                player.setVelocityY(-200);
                player.setVelocityX(-140);
                tempVX = -140;

                playerF.x = player.x;
                playerF.y = player.y+25;

                SharkJump.play();

                firstWallJump = 1;

            }

            //doubleJump
            if(player.body.touching.none)
            {
                pick = 0;
                pTouchPlat = 0;
            }
            
            if(player.body.touching.down || player.body.touching.left || player.body.touching.right)
            {
                doubleJump = 1;
                doubleJump2 = 1;
            }
            
            
            
            
            if(( W.isDown) && doubleJump == 1)
            {
                
                
                doubleJump = 0;
            }

            
            if(( W.isUp) && player.body.touching.none && doubleJump2 == 1)
            {
                
                doubleJump2 = 2;
            }

             
            
            if(( W.isDown) && ( D.isUp) && ( A.isUp) && player.body.touching.none && doubleJump2 == 2 && pick == 0)
            {
                player.setVelocityY(-300);
                doubleJump  = 0;
                doubleJump2 = 0;
                
                playerF.x = player.x;
                playerF.y = player.y+25;

                SharkJump.play();

                firstDoubleJump = 1;
            }



            if(( W.isDown) && ( D.isDown) && player.body.touching.none && doubleJump2 == 2 && pick == 0)
            {
                player.setVelocityX(200);
                tempVX = 200;
                player.setVelocityY(-300);
                doubleJump  = 0;
                doubleJump2 = 0;

                playerF.x = player.x;
                playerF.y = player.y+25;

                SharkJump.play();

                firstDoubleJump = 1;
            }

            if(( W.isDown) && ( A.isDown) && player.body.touching.none && doubleJump2 == 2 && pick == 0)
            {
                player.setVelocityX(-200);
                tempVX = -200;
                player.setVelocityY(-300);
                doubleJump  = 0;
                doubleJump2 = 0;

                playerF.x = player.x;
                playerF.y = player.y+25;

                SharkJump.play();

                firstDoubleJump = 1;
            }

            
            //Ground Pound
            if(S.isDown  )
            {
                player.setVelocityY(800);
                

            }
            
            //人物跳躍動畫設定
            if(pXV>2 && pYV<700 && player.body.touching.none)
            {
                player.anims.play('JumpRight',true);
            }

            if(pXV<-2 && pYV<700 && player.body.touching.none)
            {
                player.anims.play('JumpLeft',true);
            }
            
            
            //Ground Pound Animation
            if(pYV>=700)
            {
                player.anims.play('down');
                playerS.x = player.x;
                playerS.y = player.y+40;
                Aa.play();
                
                
                

            }
            if(pYV<700)
            {
                playerS.x = -300;
                playerS.y = -300;
            }

            //Ground Pound Shaking
            if(player.body.velocity.y >=700 && pYV >=700)
            {
                pound = 1;
            }

            if(pound == 1 && player.body.touching.down)
            {
                this.cameras.main.shake(300,0.005,false,null,null);
                pound = 0;
            }

            //GameRestart
            if(gameOver)
            {
                player.setVelocityY(0);
                restartText.setVisible(true);
                //console.log('Gameover,Restart Game');
                SharkSteps.pause();
                SharkBreath.pause();
                AmeSpawnTimer = 0;
                AmeCount = 2;
                Pl = 0;
            }

            //NextStage
            if( E.isDown && player.x>1800 && player.x<2060 && player.y>400 && unlockStage == 3)
            {
                window.close('Untitles-1.html');
                window.open('Gura_spear.html');
            }

            //NextStage blocked
            if( E.isDown && player.x>1800 && player.x<2060 && player.y>400 && unlockStage != 3)
            {
                Blocked.play();
            }
        }
    </script>
    
    
</body>
</html>